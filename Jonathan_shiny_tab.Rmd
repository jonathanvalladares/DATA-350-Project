---
title: "Untitled"
author: "DATA350"
date: "2025-11-25"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
suppressPackageStartupMessages({
  library(shiny)
  library(tidyverse)
  library(scales)
  library(ggthemes)
  library(NHANES)
})


data("NHANESraw")

nhanes_clean <- NHANESraw |>
  select(Age, Gender, Race1, BMI, Diabetes,
         Alcohol12PlusYr, Marijuana, HardDrugs,HHIncomeMid) |>
  filter(
    !is.na(Age),
    !is.na(Gender),
    !is.na(Race1),
    !is.na(BMI),
    !is.na(Diabetes)
  ) |>
  mutate(
    Gender   = droplevels(Gender),
    Race1    = droplevels(Race1),
    Diabetes = droplevels(Diabetes),
    AgeGroup = cut(
      Age,
      breaks = c(0, 20, 40, 60, 80),
      labels = c("0–20", "21–40", "41–60", "61–80")
    )
  )


nhanes_sub <- nhanes_clean |>
  pivot_longer(
    cols = c(Alcohol12PlusYr, Marijuana, HardDrugs),
    names_to = "Substance",
    values_to = "Used"
  ) |>
  filter(!is.na(Used))

nhanes_sub_labels <- nhanes_sub |>
  group_by(Substance, Gender, Used) |>
  summarise(count = n(), .groups = "drop") |>
  group_by(Substance, Gender) |>
  mutate(
    pct = count / sum(count),
    label = paste0(count, "\n(", percent(pct), ")")
  ) |>
  ungroup()

demographic_vars <- c("Gender", "Race1", "HHIncomeMid", "AgeGroup")


ui <- navbarPage(
  "NHANES App",


  tabPanel(
    "Substance Use",
    sidebarLayout(
      sidebarPanel(
        checkboxGroupInput(
          "substance_choice",
          "Choose Substance(s):",
          choices = unique(nhanes_sub$Substance),
          selected = unique(nhanes_sub$Substance)
        ),
        radioButtons(
          "position_choice",
          "Bar Position:",
          choices = c("stack", "fill", "dodge"),
          selected = "stack"
        ),
        sliderInput(
          "text_size",
          "Label Size:",
          min = 2, max = 6, value = 4
        )
      ),
      mainPanel(plotOutput("sub_plot"))
    )
  ),


  tabPanel(
    "BMI Explorer",
    
    sidebarLayout(
      sidebarPanel(
        
        selectInput(
          "bmi_group1",
          "Primary Demographic Group:",
          choices = demographic_vars,
          selected = "HHIncomeMid"
        ),
        
        selectInput(
          "bmi_group2",
          "Optional Second Group:",
          choices = c("None", demographic_vars),
          selected = "None"
        ),
        
        sliderInput(
          "bmi_alpha",
          "Transparency:",
          min = 0.2, max = 1, value = 1
        ),
        
        selectInput(
          "bmi_plot_type",
          "Plot Type:",
          choices = c("Mean Column Chart"),
          selected = "Mean Column Chart"
        ),
        
        checkboxInput(
          "bmi_add_smooth",
          "Add Smoothing Model",
          value = FALSE
        )
      ),
      
      mainPanel(plotOutput("bmi_explorer_plot"))
    )
  )
)



server <- function(input, output, session) {

 
 output$sub_plot <- renderPlot({
  
  df <- nhanes_sub_labels |>
    filter(Substance %in% input$substance_choice)
  
  
  text_position <- switch(
    input$position_choice,
    "stack" = position_stack(vjust = 0.5),
    "fill"  = position_fill(vjust = 0.5),
    "dodge" = position_dodge(width = 0.9)
  )
  
  ggplot(df, aes(x = Gender, y = count, fill = Used)) +
    geom_bar(
      stat = "identity",
      position = input$position_choice
    ) +
    geom_text(
      aes(label = label),
      position = text_position,
      size = input$text_size
    ) +
    facet_wrap(~Substance) +
    scale_fill_manual(values = c("No" = "#0072B2", "Yes" = "#D55E00")) +
    labs(
      title = "Substance Use by Gender",
      x = "Gender",
      y = "Number of Respondents",
      fill = "Used"
    ) +
    theme_economist(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0, face = "bold"),
      strip.text = element_text(face = "bold"),
      legend.position = "top"
    )
})



  output$bmi_explorer_plot <- renderPlot({
    
    df <- nhanes_clean
    g1 <- input$bmi_group1
    g2 <- input$bmi_group2
    
    
   
observeEvent(input$bmi_group1, {
  

  new_choices <- c("None", demographic_vars[demographic_vars != input$bmi_group1])
  
 
  current_g2 <- input$bmi_group2
  new_selected <- if (current_g2 == input$bmi_group1) "None" else current_g2
  
  updateSelectInput(
    session,
    "bmi_group2",
    choices = new_choices,
    selected = new_selected
  )
})

    
group_vars <- c(g1, if (g2 != "None") g2)
  
  summary_df <- df |>
    group_by(across(all_of(group_vars))) |>
    summarize(mean_BMI = mean(BMI, na.rm = TRUE), .groups = "drop")
  
  p <- ggplot(summary_df, aes(
    x = .data[[g1]],
    y = mean_BMI,
    fill = factor(.data[[g1]])    
  )) +
    geom_col(alpha = input$bmi_alpha) +
    labs(
      title = paste("Mean BMI by", g1),
      x = g1,
      y = "Mean BMI",
      fill = g1
    ) +
    theme_economist(base_size = 14) +
    theme(legend.position = "right")
  
  if (g2 != "None") {
    p <- p + facet_wrap(as.formula(paste("~", g2)))
  }
  
  if (input$bmi_add_smooth) {
    p <- p + geom_smooth(se = FALSE, color = "red")
  }
  
  p
})

    
}

shinyApp(ui, server)
```


