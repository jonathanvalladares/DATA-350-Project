---
title: "Untitled"
author: "DATA350"
date: "2025-11-25"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r}
suppressPackageStartupMessages({library(shiny)
library(tidyverse)
library(scales)
library(ggthemes)
library(NHANES)
})
data("NHANESraw")

nhanes_clean <- NHANESraw |>
  select(Age, Gender, Race1, BMI, Diabetes,
         Alcohol12PlusYr, Marijuana, HardDrugs) |>
  filter(
    !is.na(Age),
    !is.na(Gender),
    !is.na(Race1),
    !is.na(BMI),
    !is.na(Diabetes)
  ) |>
  mutate(
    Gender   = droplevels(Gender),
    Race1    = droplevels(Race1),
    Diabetes = droplevels(Diabetes),
    AgeGroup = cut(Age, breaks = c(0, 20, 40, 60, 80),
                   labels = c("0–20","21–40","41–60","61–80"))
  )


nhanes_sub <- nhanes_clean |>
  pivot_longer(
    cols = c(Alcohol12PlusYr, Marijuana, HardDrugs),
    names_to = "Substance",
    values_to = "Used"
  ) |>
  filter(!is.na(Used))

nhanes_sub_labels <- nhanes_sub |>
  group_by(Substance, Gender, Used) |>
  summarise(count = n(), .groups = "drop") |>
  group_by(Substance, Gender) |>
  mutate(
    pct = count / sum(count),
    label = paste0(count, "\n(", percent(pct), ")")
  ) |>
  ungroup()


ui <- navbarPage(
  "EDA Report App",

  #TAB 1: Substance Use
  tabPanel(
    "Substance Use",
    sidebarLayout(
      sidebarPanel(
        checkboxGroupInput(
          "substance_choice",
          "Choose Substance(s):",
          choices = unique(nhanes_sub$Substance),
          selected = unique(nhanes_sub$Substance)
        ),
        radioButtons(
          "position_choice",
          "Bar Position:",
          choices = c("stack", "fill", "dodge"),
          selected = "stack"
        ),
        sliderInput(
          "text_size",
          "Label Size:",
          min = 2, max = 6, value = 3
        )
      ),
      mainPanel(plotOutput("sub_plot"))
    )
  ),

  #TAB 2: BMI × Diabetes × Race
  tabPanel(
    "BMI & Diabetes",
    sidebarLayout(
      sidebarPanel(
        checkboxGroupInput(
          "race_choice",
          "Select Race Groups:",
          choices = unique(nhanes_clean$Race1),
          selected = unique(nhanes_clean$Race1)
        ),
        radioButtons(
          "diab_choice",
          "Include Diabetes Status:",
          choices = c("Yes", "No", "Both"),
          selected = "Both"
        ),
        sliderInput(
          "alpha_choice",
          "Curve Transparency:",
          min = 0.2, max = 1.0, value = 0.5
        )
      ),
      mainPanel(plotOutput("bmi_diab_plot"))
    )
  )
)


server <- function(input, output, session) {

  #TAB 1: Substance Use 
  output$sub_plot <- renderPlot({
    df <- nhanes_sub_labels |>
      filter(Substance %in% input$substance_choice)

    ggplot(df, aes(x = Gender, y = count, fill = Used)) +
      geom_bar(stat = "identity", position = input$position_choice) +
      geom_text(
        aes(label = label),
        position = position_stack(vjust = 0.5),
        size = input$text_size
      ) +
      facet_wrap(~Substance) +
      labs(
        title = "Substance Use by Gender",
        x = "Gender",
        y = "Number of Respondents",
        fill = "Used"
      ) +
      theme_economist(base_size = 14)
  })

  #TAB 2: BMI × Diabetes faceted by Race
  output$bmi_diab_plot <- renderPlot({
    
    df <- nhanes_clean |>
      filter(Race1 %in% input$race_choice)

    if (input$diab_choice != "Both") {
      df <- df |> filter(Diabetes == input$diab_choice)
    }

    ggplot(df, aes(x = BMI, fill = Diabetes)) +
      geom_density(alpha = input$alpha_choice, na.rm = TRUE) +
      facet_wrap(~Race1) +
      labs(
        title = "BMI Distribution by Diabetes Status & Race Group",
        x = "BMI",
        y = "Density",
        fill = "Diabetes"
      ) +
      theme_economist(base_size = 14) +
      theme(
        plot.title = element_text(hjust = 0.5, face = "bold"),
        strip.text = element_text(face = "bold")
      )
  })
}

shinyApp(ui, server)

```


